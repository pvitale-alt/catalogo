<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="icon" type="image/x-icon" href="/images/logo.ico">
    <link rel="stylesheet" href="/css/main.css?v=<%= Date.now() %>">
</head>
<body>
    <!-- Header General -->
    <header class="top-header">
        <div style="display: flex; align-items: center; gap: 12px;">
            <img src="/images/logo.png" alt="Logo" style="height: 28px; width: auto; display: block;" onerror="this.style.display='none';" />
            <span style="font-size: 16px; font-weight: 500; color: var(--text-secondary); font-family: 'Google Sans', 'Roboto', sans-serif;">Catálogo</span>
        </div>
    </header>
    
    <div class="app-container" style="margin-top: 0;">
        <%- include('../partials/sidebar', { activeMenu: 'score' }) %>
        
        <div class="main-content">
            <!-- Toolbar -->
            <div class="toolbar">
                <div class="toolbar-left">
                    <button class="button button-secondary" onclick="window.history.back()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                        </svg>
                        Volver
                    </button>
                </div>
                <div class="toolbar-right">
                    <button class="button" id="btnGuardarScore" onclick="guardarScore()">Guardar Score</button>
                </div>
            </div>
            
            <!-- Contenido -->
            <div class="content-area">
                <div class="score-calculator">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2 style="font-size: 20px; font-weight: 500; margin-bottom: 6px; margin: 0;">
                                <%= funcionalidad.titulo %>
                            </h2>
                            <% if (funcionalidad.descripcion) { %>
                                <p style="color: var(--text-secondary); font-size: 13px; margin: 4px 0 0 0;">
                                    <%= funcionalidad.descripcion %>
                                </p>
                            <% } %>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;">Score Total</div>
                            <div style="font-size: 32px; font-weight: 600; color: var(--primary-color);" id="scoreTotal">0.00</div>
                        </div>
                    </div>
                    
                    <!-- Criterios -->
                    <div style="margin-bottom: 20px;">
                        <% 
                        const criterios = [
                            { key: 'facturacion', label: 'Facturación', peso: score ? score.peso_facturacion : 40 },
                            { key: 'facturacion_potencial', label: 'Facturación Potencial', peso: score ? score.peso_facturacion_potencial : 20 },
                            { key: 'impacto_cliente', label: 'Impacto Negocio', peso: score ? score.peso_impacto_cliente : 40 },
                            { key: 'esfuerzo', label: 'Esfuerzo', peso: score ? score.peso_esfuerzo : 40 },
                            { key: 'incertidumbre', label: 'Incertidumbre', peso: score ? score.peso_incertidumbre : 30 },
                            { key: 'riesgo', label: 'Riesgo', peso: score ? score.peso_riesgo : 30 }
                        ];
                        %>
                        
                        <% 
                        const criteriosPositivos = ['facturacion', 'facturacion_potencial', 'impacto_cliente'];
                        const criteriosNegativos = ['esfuerzo', 'incertidumbre', 'riesgo'];
                        %>
                        <% criterios.forEach(criterio => { 
                            const valor = score ? (score[criterio.key] || 0) : 0;
                            const esNegativo = criteriosNegativos.includes(criterio.key);
                            const claseCriterio = esNegativo ? 'criterio-negativo' : 'criterio-positivo';
                        %>
                            <div class="criterio-row <%= claseCriterio %>">
                                <div>
                                    <div class="criterio-label"><%= criterio.label %></div>
                                    <div class="criterio-peso">Peso: <%= criterio.peso %>%</div>
                                </div>
                                <div>
                                    <input 
                                        type="range" 
                                        class="criterio-slider" 
                                        data-criterio="<%= criterio.key %>"
                                        min="0" 
                                        max="10" 
                                        value="<%= valor %>"
                                        step="1"
                                    >
                                </div>
                                <div class="criterio-value" data-value="<%= criterio.key %>">
                                    <%= valor %>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/js/main.js"></script>
    <script>
        // Inicializar valores actuales
        const funcionalidadId = <%- JSON.stringify(funcionalidad.redmine_id || funcionalidad.id) %>;
        const tipo = '<%= tipo || "funcionalidad" %>';
        
        // Cargar valores actuales al inicializar
        document.addEventListener('DOMContentLoaded', () => {
            if (window.scoreCalculator) {
                <% if (score) { %>
                    // Cargar criterios existentes (sin urgencia)
                    scoreCalculator.criterios = {
                        facturacion: <%= score.facturacion || 0 %>,
                        facturacion_potencial: <%= score.facturacion_potencial || 0 %>,
                        impacto_cliente: <%= score.impacto_cliente || 0 %>,
                        esfuerzo: <%= score.esfuerzo || 0 %>,
                        incertidumbre: <%= score.incertidumbre || 0 %>,
                        riesgo: <%= score.riesgo || 0 %>
                    };
                    
                    // Cargar pesos existentes (usando nombres correctos con prefijo peso_)
                    scoreCalculator.pesos = {
                        peso_facturacion: <%= score.peso_facturacion || 40 %>,
                        peso_facturacion_potencial: <%= score.peso_facturacion_potencial || 20 %>,
                        peso_impacto_cliente: <%= score.peso_impacto_cliente || 40 %>,
                        peso_esfuerzo: <%= score.peso_esfuerzo || 40 %>,
                        peso_incertidumbre: <%= score.peso_incertidumbre || 30 %>,
                        peso_riesgo: <%= score.peso_riesgo || 30 %>
                    };
                    
                    // Recalcular score con los valores cargados
                    scoreCalculator.calcularScore();
                <% } else { %>
                    // Si no hay score, inicializar con valores por defecto y calcular
                    scoreCalculator.calcularScore();
                <% } %>
            }
        });
        
        async function guardarScore() {
            if (window.scoreCalculator) {
                const btnGuardar = document.getElementById('btnGuardarScore');
                const textoOriginal = btnGuardar.textContent;
                
                // Deshabilitar botón y mostrar "guardando"
                btnGuardar.disabled = true;
                btnGuardar.textContent = 'Guardando...';
                
                try {
                    const resultado = await scoreCalculator.guardarScore(funcionalidadId);
                    if (resultado !== null) {
                        // Redireccionar según el tipo
                        let redirectUrl = '/funcionalidades';
                        if (tipo === 'proyectos-internos') {
                            redirectUrl = '/proyectos-internos';
                        } else if (tipo === 'ideas-mejoras') {
                            redirectUrl = '/ideas-mejoras';
                        }
                        setTimeout(() => {
                            window.location.href = redirectUrl;
                        }, 500);
                    } else {
                        // Restaurar botón si hubo error
                        btnGuardar.disabled = false;
                        btnGuardar.textContent = textoOriginal;
                        alert('Error al guardar el score. Por favor, intente nuevamente.');
                    }
                } catch (error) {
                    console.error('Error al guardar:', error);
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = textoOriginal;
                    alert('Error al guardar el score. Por favor, intente nuevamente.');
                }
            }
        }
    </script>
</body>
</html>

