<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="icon" type="image/x-icon" href="/images/logo.ico">
    <link rel="stylesheet" href="/css/main.css?v=<%= Date.now() %>">
</head>
<body>
    <!-- Header General -->
    <header class="top-header">
        <div style="display: flex; align-items: center; gap: 12px;">
            <img src="/images/logo.png" alt="Logo" style="height: 28px; width: auto; display: block;" onerror="this.style.display='none';" />
            <span style="font-size: 16px; font-weight: 500; color: var(--text-secondary); font-family: 'Google Sans', 'Roboto', sans-serif;">Cat√°logo</span>
        </div>
    </header>
    
    <div class="app-container" style="margin-top: 0;">
        <%- include('../partials/sidebar', { activeMenu: 'score' }) %>
        
        <div class="main-content">
            <!-- Contenido -->
            <div class="content-area" style="padding-top: 0;">
                <% if (ranking.length === 0) { %>
                    <div class="empty-state">
                        <div class="empty-state-icon">‚≠ê</div>
                        <div class="empty-state-text">No hay funcionalidades evaluadas</div>
                        <div class="empty-state-subtext">Comienza evaluando funcionalidades desde el m√≥dulo principal</div>
                    </div>
                <% } else { %>
                    <!-- Estad√≠sticas Globales -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div class="card" style="cursor: default; padding: 16px;">
                            <div class="text-muted text-small">Score Promedio</div>
                            <div style="font-size: 28px; font-weight: 600; color: var(--primary-color); margin-top: 4px;">
                                <%= estadisticas.promedio ? parseFloat(estadisticas.promedio).toFixed(2) : '0.00' %>
                            </div>
                        </div>
                        
                        <div class="card" style="cursor: default; padding: 16px;">
                            <div class="text-muted text-small">Score M√°ximo</div>
                            <div style="font-size: 28px; font-weight: 600; color: #1e8e3e; margin-top: 4px;">
                                <%= estadisticas.maximo ? parseFloat(estadisticas.maximo).toFixed(2) : '0.00' %>
                            </div>
                        </div>
                        
                        <div class="card" style="cursor: default; padding: 16px;">
                            <div class="text-muted text-small">Score M√≠nimo</div>
                            <div style="font-size: 28px; font-weight: 600; color: #d93025; margin-top: 4px;">
                                <%= estadisticas.minimo ? parseFloat(estadisticas.minimo).toFixed(2) : '0.00' %>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ranking -->
                    <div class="list-view">
                        <div class="list-header" style="grid-template-columns: 2fr 1fr 100px 100px;">
                            <div>Funcionalidad</div>
                            <div>Secci√≥n</div>
                            <div style="text-align: center;">Score</div>
                            <div style="text-align: center;">Acciones</div>
                        </div>
                        
                        <% ranking.forEach((func, index) => { 
                            let score = func.score_calculado || 0;
                            score = parseFloat(score) || 0;
                            let scoreClass = 'score-low';
                            if (score > 6.50) scoreClass = 'score-high';
                            else if (score > 4) scoreClass = 'score-medium';
                            
                            let medalIcon = '';
                            if (index === 0) medalIcon = 'ü•á';
                            else if (index === 1) medalIcon = 'ü•à';
                            else if (index === 2) medalIcon = 'ü•â';
                        %>
                            <% 
                            // Extraer solo lo que est√° despu√©s de " | " en el t√≠tulo
                            let tituloCompleto = func.titulo || 'Sin t√≠tulo';
                            let tituloMostrar = tituloCompleto;
                            if (tituloCompleto.includes(' | ')) {
                                const partes = tituloCompleto.split(' | ');
                                tituloMostrar = partes.length > 1 ? partes.slice(1).join(' | ').trim() : tituloCompleto;
                            }
                            %>
                            <div class="list-item" style="grid-template-columns: 2fr 1fr 100px 100px;">
                                <div class="item-title">
                                    <div class="item-icon">
                                        <%= (tituloMostrar || '?').substring(0, 1).toUpperCase() %>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <% if (medalIcon) { %>
                                            <span style="font-size: 18px;"><%= medalIcon %></span>
                                        <% } else { %>
                                            <span style="font-size: 14px; color: var(--text-secondary); font-weight: 500;"><%= index + 1 %></span>
                                        <% } %>
                                        <%= tituloMostrar.length > 60 ? tituloMostrar.substring(0, 60) + '...' : tituloMostrar %>
                                    </div>
                                </div>
                                <div class="item-text"><%= func.seccion || '-' %></div>
                                <div style="text-align: center;">
                                    <span class="score-badge <%= scoreClass %>">
                                        <%= score.toFixed(2) %>
                                    </span>
                                </div>
                                <div style="text-align: center;">
                                    <button 
                                        class="button" 
                                        onclick='window.location.href="/score/calculadora/" + encodeURIComponent(<%- JSON.stringify(func.redmine_id || func.id) %>)'
                                    >
                                        Evaluar
                                    </button>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
    
    <script src="/js/main.js"></script>
</body>
</html>
