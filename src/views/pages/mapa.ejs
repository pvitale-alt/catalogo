<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/main.css?v=<%= Date.now() %>">
</head>
<body>
    <!-- Header General -->
    <header class="top-header">
        <div style="display: flex; align-items: center; gap: 12px;">
            <img src="/images/logo.png" alt="Logo" style="height: 28px; width: auto; display: block;" onerror="this.style.display='none';" />
            <span onclick="window.location.href='/funcionalidades'" style="font-size: 16px; font-weight: 500; color: var(--text-secondary); font-family: 'Google Sans', 'Roboto', sans-serif; cursor: pointer; transition: color 0.2s;" onmouseover="this.style.color='var(--primary-color)'" onmouseout="this.style.color='var(--text-secondary)'">Catálogo</span>
        </div>
    </header>
    
    <div class="app-container" style="margin-top: 0;">
        <%- include('../partials/sidebar', { activeMenu: 'mapa' }) %>
        
        <div class="main-content">
            <!-- Contenido -->
            <div class="content-area" style="padding-top: 0;">
                
                <!-- Contenedor con scroll horizontal y flechas -->
                <div style="position: relative;">
                    <!-- Flecha izquierda -->
                    <button id="scrollLeftBtn" onclick="scrollTable(-200)" style="display: none; position: absolute; left: 0; top: 50%; transform: translateY(-50%); z-index: 10; background: white; border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; align-items: center; justify-content: center; display: flex;" onmouseover="this.style.background='#f1f3f4'" onmouseout="this.style.background='white'">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                        </svg>
                    </button>
                    
                    <!-- Flecha derecha -->
                    <button id="scrollRightBtn" onclick="scrollTable(200)" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); z-index: 10; background: white; border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; align-items: center; justify-content: center; display: flex;" onmouseover="this.style.background='#f1f3f4'" onmouseout="this.style.background='white'">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                        </svg>
                    </button>
                
                    <!-- Mapa Grid -->
                    <div class="mapa-grid" id="mapaGrid" style="overflow-x: auto; position: relative;">
                        <table class="mapa-table" id="mapaTable">
                            <thead>
                                <tr>
                                    <th style="min-width: 200px; width: 200px; background: var(--hover-bg); font-weight: 600; font-size: 14px; color: var(--text-primary); padding: 16px 24px; border-bottom: 1px solid var(--border-color); position: sticky; left: 0; z-index: 5; background: var(--hover-bg);">Funcionalidad</th>
                                    <% clientes.forEach((cliente, index) => { %>
                                        <th 
                                            class="cliente-header" 
                                            data-cliente-index="<%= index %>"
                                            data-cliente-id="<%= cliente.id %>"
                                            data-cliente-nombre="<%= cliente.nombre %>"
                                            draggable="true"
                                            onclick="ordenarPorCliente(<%= index %>)"
                                            style="min-width: 25px; width: 28px; background: var(--hover-bg); font-weight: 600; font-size: 12px; color: var(--text-primary); padding: 8px 4px; border-bottom: 1px solid var(--border-color); cursor: move; user-select: none; transition: background 0.2s;"
                                            onmouseover="this.style.background='#e8f0fe'"
                                            onmouseout="if (!this.classList.contains('sorted')) this.style.background='var(--hover-bg)'"
                                            title="Arrastrar para reordenar o click para ordenar"
                                        >
                                            <%= cliente.nombre %>
                                            <span class="sort-indicator" style="display: none; margin-left: 4px; font-size: 10px;">▼</span>
                                        </th>
                                    <% }) %>
                                </tr>
                            </thead>
                        <tbody>
                            <% funcionalidades.forEach(func => { %>
                                <tr>
                                    <td style="font-weight: 500; font-size: 11px; padding: 8px 12px; border: 1px solid rgba(218, 220, 224, 0.1); position: sticky; left: 0; z-index: 3; background: white;">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <div class="item-icon" style="flex-shrink: 0; width: 20px; height: 20px; font-size: 10px;">
                                                <%= (func.titulo || '?').substring(0, 1).toUpperCase() %>
                                            </div>
                                            <div style="font-size: 11px; line-height: 1.3;">
                                                <%= (func.titulo || 'Sin título').length > 60 ? (func.titulo || 'Sin título').substring(0, 60) + '...' : (func.titulo || 'Sin título') %>
                                            </div>
                                        </div>
                                    </td>
                                    <% clientes.forEach(cliente => { 
                                        const key = `${cliente.id}-${func.redmine_id || func.id}`;
                                        const relacion = relaciones[key];
                                        let estado = relacion ? relacion.estado : null;
                                        let claseEstado = '';
                                        let textoEstado = '-';
                                        
                                        if (estado) {
                                            textoEstado = estado;
                                            if (estado === 'productivo') claseEstado = 'estado-implementado';
                                            else if (estado === 'en desarrollo') claseEstado = 'estado-desarrollo';
                                            else if (estado === 'interesado') claseEstado = 'estado-planificado';
                                            else if (estado === 'rechazado') claseEstado = 'estado-cancelado';
                                            else if (estado === 'Propuesta enviada') claseEstado = 'estado-planificado';
                                        }
                                    %>
                                        <% 
                                        let cellStyle = '';
                                        if (estado) {
                                            if (estado === 'productivo') {
                                                cellStyle = 'background: rgba(200, 230, 201, 0.25); padding: 2px 4px; width: 35px; height: 24px; position: relative; cursor: pointer; text-align: center; color: var(--text-secondary); font-size: 11px;';
                                            } else if (estado === 'en desarrollo') {
                                                cellStyle = 'background: rgba(255, 249, 196, 0.25); padding: 2px 4px; width: 35px; height: 24px; position: relative; cursor: pointer; text-align: center; color: var(--text-secondary); font-size: 11px;';
                                            } else if (estado === 'interesado') {
                                                cellStyle = 'background: rgba(187, 222, 251, 0.25); padding: 2px 4px; width: 35px; height: 24px; position: relative; cursor: pointer; text-align: center; color: var(--text-secondary); font-size: 11px;';
                                            } else if (estado === 'rechazado') {
                                                cellStyle = 'background: rgba(255, 205, 210, 0.25); padding: 2px 4px; width: 35px; height: 24px; position: relative; cursor: pointer; text-align: center; color: var(--text-secondary); font-size: 11px;';
                                            } else if (estado === 'Propuesta enviada') {
                                                cellStyle = 'background: rgba(225, 190, 231, 0.25); padding: 2px 4px; width: 35px; height: 24px; position: relative; cursor: pointer; text-align: center; color: var(--text-secondary); font-size: 11px;';
                                            } else {
                                                cellStyle = 'background: rgba(245, 245, 245, 0.25); padding: 2px 4px; width: 35px; height: 24px; position: relative; cursor: pointer; text-align: center; color: var(--text-secondary); font-size: 11px;';
                                            }
                                        } else {
                                            cellStyle = 'background: transparent; padding: 2px 4px; width: 35px; height: 24px; position: relative; cursor: pointer; text-align: center; color: var(--text-secondary); font-size: 11px;';
                                        }
                                        %>
                                        <td class="mapa-cell item-text" 
                                            style="<%= cellStyle %> width: 28px; min-width: 28px; position: relative;"
                                            onclick="mostrarDropdownEstado(event, <%= cliente.id %>, <%= func.redmine_id || func.id %>, '<%= estado || null %>')"
                                            data-cliente="<%= cliente.id %>"
                                            data-funcionalidad="<%= func.redmine_id || func.id %>"
                                            data-estado="<%= estado ? textoEstado : '' %>"
                                        >
                                            <%= estado ? textoEstado : '+' %>
                                            <!-- Dropdown de estados -->
                                            <div id="dropdown-estado-<%= cliente.id %>-<%= func.redmine_id || func.id %>" 
                                                 class="dropdown-estado"
                                                 style="display: none; position: fixed; z-index: 10000; background: white; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); min-width: 180px; max-width: 250px;">
                                                <% 
                                                const estadosDisponibles = ['productivo', 'interesado', 'rechazado', 'en desarrollo', 'Propuesta enviada'];
                                                estadosDisponibles.forEach(estadoDisponible => {
                                                %>
                                                    <div 
                                                        onclick="seleccionarEstado(<%= cliente.id %>, <%= func.redmine_id || func.id %>, '<%= estadoDisponible %>')"
                                                        style="padding: 10px 16px; cursor: pointer; font-size: 13px; transition: background 0.2s; <%= estado === estadoDisponible ? 'background: #e8f0fe; font-weight: 500;' : '' %>"
                                                        onmouseover="this.style.background='#f1f3f4'"
                                                        onmouseout="this.style.background='<%= estado === estadoDisponible ? '#e8f0fe' : 'white' %>'"
                                                    >
                                                        <%= estadoDisponible.charAt(0).toUpperCase() + estadoDisponible.slice(1) %>
                                                    </div>
                                                <% }) %>
                                                <div 
                                                    onclick="seleccionarEstado(<%= cliente.id %>, <%= func.redmine_id || func.id %>, null)"
                                                    style="padding: 10px 16px; cursor: pointer; font-size: 13px; border-top: 1px solid var(--border-color); color: var(--text-secondary); transition: background 0.2s;"
                                                    onmouseover="this.style.background='#f1f3f4'"
                                                    onmouseout="this.style.background='white'"
                                                >
                                                    Limpiar
                                                </div>
                                            </div>
                                        </td>
                                    <% }) %>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                    </div>
                </div>
                
                <!-- Métricas y Gráficos -->
                <div style="margin-top: 32px;">
                    <!-- Tarjetas de métricas principales -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 32px;">
                        <!-- Total Clientes -->
                        <div class="glue-card" style="background: white; border: 1px solid #dadce0; border-radius: 8px; padding: 24px; transition: box-shadow 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(60,64,67,.15)'" onmouseout="this.style.boxShadow='none'">
                            <div class="glue-card__content" style="font-size: 14px; color: #5f6368; margin-bottom: 16px; font-family: 'Google Sans', 'Roboto', sans-serif; font-weight: 400;">
                                Total Clientes
                            </div>
                            <div style="font-size: 48px; font-weight: 400; color: #202124; font-family: 'Google Sans', 'Roboto', sans-serif; line-height: 1.2;">
                                <%= clientes.length %>
                            </div>
                        </div>
                        
                        <!-- Total Funcionalidades -->
                        <div class="glue-card" style="background: white; border: 1px solid #dadce0; border-radius: 8px; padding: 24px; transition: box-shadow 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(60,64,67,.15)'" onmouseout="this.style.boxShadow='none'">
                            <div class="glue-card__content" style="font-size: 14px; color: #5f6368; margin-bottom: 16px; font-family: 'Google Sans', 'Roboto', sans-serif; font-weight: 400;">
                                Total Funcionalidades
                            </div>
                            <div style="font-size: 48px; font-weight: 400; color: #202124; font-family: 'Google Sans', 'Roboto', sans-serif; line-height: 1.2;">
                                <%= funcionalidades.length %>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gráficos -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
                        <!-- Gráfico de Barras - Estados Comerciales -->
                        <div class="glue-card" style="background: white; border: 1px solid #dadce0; border-radius: 8px; padding: 24px;">
                            <div class="glue-card__content" style="font-size: 16px; color: #202124; margin-bottom: 24px; font-family: 'Google Sans', 'Roboto', sans-serif; font-weight: 500;">
                                Estados Comerciales
                            </div>
                            <div id="barChartContainer" style="height: 300px; position: relative;">
                                <svg id="barChart" width="100%" height="100%" viewBox="0 0 400 300" style="overflow: visible;">
                                    <!-- Ejes y líneas de referencia se dibujan con JavaScript -->
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Gráfico de Barras - Funcionalidades Productivas por Cliente -->
                        <div class="glue-card" style="background: white; border: 1px solid #dadce0; border-radius: 8px; padding: 24px;">
                            <div class="glue-card__content" style="font-size: 16px; color: #202124; margin-bottom: 24px; font-family: 'Google Sans', 'Roboto', sans-serif; font-weight: 500;">
                                Funcionalidades Productivas
                            </div>
                            <div id="productivasChartContainer" style="height: 300px; position: relative; width: 100%;">
                                <svg id="productivasChart" width="100%" height="100%" viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet" style="overflow: visible;">
                                    <!-- Gráfico de barras por cliente se dibuja con JavaScript -->
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Clientes y Top Funcionalidades -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-top: 24px;">
                        <!-- Top Clientes -->
                        <div class="glue-card" style="background: white; border: 1px solid #dadce0; border-radius: 8px; padding: 24px;">
                            <div class="glue-card__content" style="font-size: 16px; color: #202124; margin-bottom: 24px; font-family: 'Google Sans', 'Roboto', sans-serif; font-weight: 500;">
                                Top Clientes
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <% if (estadisticas.top_clientes && estadisticas.top_clientes.length > 0) { %>
                                    <% estadisticas.top_clientes.forEach((cliente, index) => { %>
                                        <div style="display: flex; align-items: center; gap: 16px; padding: 12px; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
                                            <div style="width: 32px; height: 32px; border-radius: 50%; background: rgba(52, 168, 83, 0.1); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; color: #34a853; font-family: 'Google Sans', 'Roboto', sans-serif; flex-shrink: 0;">
                                                <%= index + 1 %>
                                            </div>
                                            <div style="flex: 1; font-size: 14px; color: #202124; font-family: 'Google Sans', 'Roboto', sans-serif;">
                                                <%= cliente.nombre %>
                                            </div>
                                            <div style="font-size: 18px; font-weight: 500; color: #34a853; font-family: 'Google Sans', 'Roboto', sans-serif;">
                                                <%= cliente.cantidad_productivas %>
                                            </div>
                                            <div style="font-size: 12px; color: #5f6368; font-family: 'Google Sans', 'Roboto', sans-serif;">
                                                funcionalidades
                                            </div>
                                        </div>
                                    <% }) %>
                                <% } else { %>
                                    <div style="text-align: center; padding: 24px; color: #5f6368; font-family: 'Google Sans', 'Roboto', sans-serif;">
                                        No hay datos disponibles
                                    </div>
                                <% } %>
                            </div>
                        </div>
                        
                        <!-- Top Funcionalidades -->
                        <div class="glue-card" style="background: white; border: 1px solid #dadce0; border-radius: 8px; padding: 24px;">
                            <div class="glue-card__content" style="font-size: 16px; color: #202124; margin-bottom: 24px; font-family: 'Google Sans', 'Roboto', sans-serif; font-weight: 500;">
                                Top Funcionalidades
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <% if (topFuncionalidades && topFuncionalidades.length > 0) { %>
                                    <% topFuncionalidades.forEach((func, index) => { %>
                                        <div style="display: flex; align-items: center; gap: 16px; padding: 12px; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
                                            <div style="width: 32px; height: 32px; border-radius: 50%; background: rgba(66, 133, 244, 0.1); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; color: #4285f4; font-family: 'Google Sans', 'Roboto', sans-serif; flex-shrink: 0;">
                                                <%= index + 1 %>
                                            </div>
                                            <div style="flex: 1; font-size: 14px; color: #202124; font-family: 'Google Sans', 'Roboto', sans-serif; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                <%= (func.titulo || 'Sin título').length > 90 ? (func.titulo || 'Sin título').substring(0, 90) + '...' : (func.titulo || 'Sin título') %>
                                            </div>
                                            <div style="font-size: 18px; font-weight: 500; color: #4285f4; font-family: 'Google Sans', 'Roboto', sans-serif;">
                                                <%= func.cantidad_clientes %>
                                            </div>
                                            <div style="font-size: 12px; color: #5f6368; font-family: 'Google Sans', 'Roboto', sans-serif;">
                                                clientes
                                            </div>
                                        </div>
                                    <% }) %>
                                <% } else { %>
                                    <div style="text-align: center; padding: 24px; color: #5f6368; font-family: 'Google Sans', 'Roboto', sans-serif;">
                                        No hay datos disponibles
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
                
                <script>
                    // Datos para gráficos
                    <% 
                    const estadosComerciales = ['productivo', 'interesado', 'rechazado', 'en desarrollo', 'Propuesta enviada'];
                    const estadosCount = {};
                    const estadosColores = {
                        'productivo': 'rgba(52, 168, 83, 0.6)',
                        'interesado': 'rgba(251, 188, 4, 0.6)',
                        'rechazado': 'rgba(234, 67, 53, 0.6)',
                        'en desarrollo': 'rgba(66, 133, 244, 0.6)',
                        'Propuesta enviada': 'rgba(154, 160, 166, 0.6)'
                    };
                    estadisticas.por_estado.forEach(e => {
                        estadosCount[e.estado_comercial] = e.cantidad;
                    });
                    const datosEstados = estadosComerciales.map(estado => ({
                        nombre: estado.charAt(0).toUpperCase() + estado.slice(1),
                        cantidad: estadosCount[estado] || 0,
                        color: estadosColores[estado] || '#9aa0a6'
                    })).filter(d => d.cantidad > 0);
                    const maxCantidad = Math.max(...datosEstados.map(d => d.cantidad), 1);
                    %>
                    const datosEstados = <%- JSON.stringify(datosEstados) %>;
                    const maxCantidad = <%= maxCantidad %>;
                    const estadosColores = <%- JSON.stringify(estadosColores) %>;
                    
                    // Datos de funcionalidades productivas por cliente
                    <% 
                    const productivasPorCliente = estadisticas.productivas_por_cliente || [];
                    const maxProductivas = Math.max(...productivasPorCliente.map(c => c.cantidad_productivas), 1);
                    %>
                    const productivasPorCliente = <%- JSON.stringify(productivasPorCliente) %>;
                    const maxProductivas = <%= maxProductivas %>;
                    
                    // Dibujar gráfico de barras
                    function dibujarGraficoBarras() {
                        const svg = document.getElementById('barChart');
                        if (!svg || datosEstados.length === 0) return;
                        
                        const width = 400;
                        const height = 300;
                        const margin = { top: 20, right: 20, bottom: 40, left: 50 };
                        const chartWidth = width - margin.left - margin.right;
                        const chartHeight = height - margin.top - margin.bottom;
                        const barWidth = chartWidth / datosEstados.length * 0.6;
                        const barSpacing = chartWidth / datosEstados.length;
                        
                        // Limpiar SVG
                        svg.innerHTML = '';
                        
                        // Eje Y (líneas de referencia)
                        for (let i = 0; i <= 5; i++) {
                            const y = margin.top + chartHeight - (chartHeight / 5) * i;
                            const value = Math.round((maxCantidad / 5) * i);
                            
                            // Línea de referencia
                            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                            line.setAttribute('x1', margin.left);
                            line.setAttribute('x2', width - margin.right);
                            line.setAttribute('y1', y);
                            line.setAttribute('y2', y);
                            line.setAttribute('stroke', '#e8eaed');
                            line.setAttribute('stroke-width', '1');
                            svg.appendChild(line);
                            
                            // Etiqueta
                            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            text.setAttribute('x', margin.left - 10);
                            text.setAttribute('y', y + 4);
                            text.setAttribute('text-anchor', 'end');
                            text.setAttribute('font-size', '11');
                            text.setAttribute('fill', '#5f6368');
                            text.setAttribute('font-family', 'Google Sans, Roboto, sans-serif');
                            text.textContent = value;
                            svg.appendChild(text);
                        }
                        
                        // Barras
                        datosEstados.forEach((dato, index) => {
                            const barHeight = (dato.cantidad / maxCantidad) * chartHeight;
                            const x = margin.left + (barSpacing * index) + (barSpacing - barWidth) / 2;
                            const y = margin.top + chartHeight - barHeight;
                            
                            // Barra
                            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                            rect.setAttribute('x', x);
                            rect.setAttribute('y', y);
                            rect.setAttribute('width', barWidth);
                            rect.setAttribute('height', barHeight);
                            rect.setAttribute('fill', dato.color);
                            rect.setAttribute('rx', '4');
                            rect.style.transition = 'opacity 0.2s';
                            rect.onmouseover = function() { this.style.opacity = '0.8'; };
                            rect.onmouseout = function() { this.style.opacity = '1'; };
                            svg.appendChild(rect);
                            
                            // Etiqueta del eje X
                            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            label.setAttribute('x', x + barWidth / 2);
                            label.setAttribute('y', height - margin.bottom + 20);
                            label.setAttribute('text-anchor', 'middle');
                            label.setAttribute('font-size', '11');
                            label.setAttribute('fill', '#5f6368');
                            label.setAttribute('font-family', 'Google Sans, Roboto, sans-serif');
                            label.textContent = dato.nombre;
                            svg.appendChild(label);
                        });
                    }
                    
                    // Dibujar gráfico de funcionalidades productivas por cliente
                    function dibujarGraficoProductivas() {
                        const svg = document.getElementById('productivasChart');
                        if (!svg || productivasPorCliente.length === 0) return;
                        
                        // Usar el ancho completo del contenedor SVG
                        const svgElement = svg;
                        const width = svgElement.clientWidth || 500;
                        const height = 300;
                        const margin = { top: 20, right: 20, bottom: 60, left: 40 }; // Reducido margen izquierdo
                        const chartWidth = width - margin.left - margin.right;
                        const chartHeight = height - margin.top - margin.bottom;
                        // Aumentar el espaciado entre barras usando un factor de espaciado
                        const spacingFactor = 1.2; // Factor para aumentar el espacio entre barras
                        const totalSpacing = chartWidth * spacingFactor;
                        const barSpacing = totalSpacing / productivasPorCliente.length;
                        const barWidth = barSpacing * 0.4; // Barras más estrechas para más espacio
                        
                        // Limpiar SVG
                        svg.innerHTML = '';
                        
                        // Color suave para las barras
                        const barColor = 'rgba(52, 168, 83, 0.5)'; // Verde suave
                        
                        // Eje Y (líneas de referencia)
                        for (let i = 0; i <= 5; i++) {
                            const y = margin.top + chartHeight - (chartHeight / 5) * i;
                            const value = Math.round((maxProductivas / 5) * i);
                            
                            // Línea de referencia
                            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                            line.setAttribute('x1', margin.left);
                            line.setAttribute('x2', width - margin.right);
                            line.setAttribute('y1', y);
                            line.setAttribute('y2', y);
                            line.setAttribute('stroke', '#e8eaed');
                            line.setAttribute('stroke-width', '1');
                            svg.appendChild(line);
                            
                            // Etiqueta
                            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            text.setAttribute('x', margin.left - 10);
                            text.setAttribute('y', y + 4);
                            text.setAttribute('text-anchor', 'end');
                            text.setAttribute('font-size', '11');
                            text.setAttribute('fill', '#5f6368');
                            text.setAttribute('font-family', 'Google Sans, Roboto, sans-serif');
                            text.textContent = value;
                            svg.appendChild(text);
                        }
                        
                        // Barras
                        productivasPorCliente.forEach((cliente, index) => {
                            const barHeight = (cliente.cantidad_productivas / maxProductivas) * chartHeight;
                            // Centrar las barras en el espacio disponible, dejando más espacio entre ellas
                            const x = margin.left + (barSpacing * index) + (barSpacing - barWidth) / 2;
                            const y = margin.top + chartHeight - barHeight;
                            
                            // Barra
                            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                            rect.setAttribute('x', x);
                            rect.setAttribute('y', y);
                            rect.setAttribute('width', barWidth);
                            rect.setAttribute('height', barHeight);
                            rect.setAttribute('fill', barColor);
                            rect.setAttribute('rx', '4');
                            rect.style.transition = 'opacity 0.2s';
                            rect.onmouseover = function() { this.style.opacity = '0.7'; };
                            rect.onmouseout = function() { this.style.opacity = '1'; };
                            svg.appendChild(rect);
                            
                            // Etiqueta del eje X (nombre del cliente)
                            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            label.setAttribute('x', x + barWidth / 2);
                            label.setAttribute('y', height - margin.bottom + 20);
                            label.setAttribute('text-anchor', 'middle');
                            label.setAttribute('font-size', '11');
                            label.setAttribute('fill', '#5f6368');
                            label.setAttribute('font-family', 'Google Sans, Roboto, sans-serif');
                            label.textContent = cliente.nombre;
                            svg.appendChild(label);
                        });
                    }
                    
                    // Inicializar gráficos cuando el DOM esté listo
                    document.addEventListener('DOMContentLoaded', () => {
                        dibujarGraficoBarras();
                        dibujarGraficoProductivas();
                    });
                </script>
            </div>
        </div>
    </div>
    
    <script src="/js/main.js"></script>
    <script>
        // Variables para ordenamiento
        let ordenActual = null;
        let ordenDireccion = 'asc'; // 'asc' o 'desc'
        
        // Funciones de scroll horizontal
        function scrollTable(direction) {
            const grid = document.getElementById('mapaGrid');
            if (grid) {
                grid.scrollBy({ left: direction, behavior: 'smooth' });
                actualizarFlechasScroll();
            }
        }
        
        function actualizarFlechasScroll() {
            const grid = document.getElementById('mapaGrid');
            const leftBtn = document.getElementById('scrollLeftBtn');
            const rightBtn = document.getElementById('scrollRightBtn');
            
            if (grid && leftBtn && rightBtn) {
                // Mostrar/ocultar flecha izquierda
                if (grid.scrollLeft > 0) {
                    leftBtn.style.display = 'flex';
                } else {
                    leftBtn.style.display = 'none';
                }
                
                // Mostrar/ocultar flecha derecha
                const maxScroll = grid.scrollWidth - grid.clientWidth;
                if (grid.scrollLeft < maxScroll - 10) {
                    rightBtn.style.display = 'flex';
                } else {
                    rightBtn.style.display = 'none';
                }
            }
        }
        
        // Ordenar por cliente
        function ordenarPorCliente(clienteIndex) {
            const tbody = document.querySelector('#mapaTable tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determinar dirección de ordenamiento
            const header = document.querySelector(`.cliente-header[data-cliente-index="${clienteIndex}"]`);
            if (ordenActual === clienteIndex) {
                ordenDireccion = ordenDireccion === 'asc' ? 'desc' : 'asc';
            } else {
                ordenDireccion = 'asc';
                ordenActual = clienteIndex;
            }
            
            // Limpiar indicadores anteriores
            document.querySelectorAll('.cliente-header').forEach(h => {
                h.classList.remove('sorted');
                h.querySelector('.sort-indicator').style.display = 'none';
            });
            
            // Marcar header actual
            header.classList.add('sorted');
            const indicator = header.querySelector('.sort-indicator');
            indicator.style.display = 'inline';
            indicator.textContent = ordenDireccion === 'asc' ? '▲' : '▼';
            
            // Ordenar filas según el estado en la columna del cliente
            rows.sort((a, b) => {
                const cellA = a.querySelectorAll('td')[clienteIndex + 1]; // +1 porque la primera columna es funcionalidad
                const cellB = b.querySelectorAll('td')[clienteIndex + 1];
                
                const estadoA = cellA.getAttribute('data-estado') || '';
                const estadoB = cellB.getAttribute('data-estado') || '';
                
                // Ordenar: primero las que tienen estado, luego las vacías
                if (estadoA && !estadoB) return ordenDireccion === 'asc' ? -1 : 1;
                if (!estadoA && estadoB) return ordenDireccion === 'asc' ? 1 : -1;
                if (!estadoA && !estadoB) return 0;
                
                // Si ambas tienen estado, ordenar alfabéticamente
                const comparacion = estadoA.localeCompare(estadoB);
                return ordenDireccion === 'asc' ? comparacion : -comparacion;
            });
            
            // Reordenar filas en el DOM
            rows.forEach(row => tbody.appendChild(row));
        }
        
        // Actualizar flechas al hacer scroll
        document.addEventListener('DOMContentLoaded', () => {
            const grid = document.getElementById('mapaGrid');
            if (grid) {
                grid.addEventListener('scroll', actualizarFlechasScroll);
                actualizarFlechasScroll();
            }
            
            // Agregar data-estado a las celdas para ordenamiento
            document.querySelectorAll('.mapa-cell').forEach(cell => {
                const texto = cell.textContent.trim();
                if (texto && texto !== '+') {
                    cell.setAttribute('data-estado', texto);
                }
            });
        });
        
        // Funciones para dropdown de estados
        function mostrarDropdownEstado(event, clienteId, funcionalidadId, estadoActual) {
            event.stopPropagation();
            event.preventDefault();
            
            // Cerrar otros dropdowns
            document.querySelectorAll('.dropdown-estado').forEach(dropdown => {
                if (dropdown.id !== `dropdown-estado-${clienteId}-${funcionalidadId}`) {
                    dropdown.style.display = 'none';
                }
            });
            
            // Toggle del dropdown actual
            const dropdown = document.getElementById(`dropdown-estado-${clienteId}-${funcionalidadId}`);
            const cell = event.currentTarget;
            
            if (dropdown) {
                const isVisible = dropdown.style.display === 'block';
                
                if (!isVisible) {
                    // Obtener posición de la celda
                    const rect = cell.getBoundingClientRect();
                    
                    // Posicionar el dropdown de forma absoluta respecto al viewport
                    dropdown.style.position = 'fixed';
                    dropdown.style.top = (rect.bottom + 4) + 'px';
                    dropdown.style.left = rect.left + 'px';
                    dropdown.style.zIndex = '10000';
                    dropdown.style.display = 'block';
                    
                    // Asegurar que el dropdown no se salga de la pantalla
                    setTimeout(() => {
                        const dropdownRect = dropdown.getBoundingClientRect();
                        if (dropdownRect.right > window.innerWidth) {
                            dropdown.style.left = (window.innerWidth - dropdownRect.width - 10) + 'px';
                        }
                        if (dropdownRect.bottom > window.innerHeight) {
                            dropdown.style.top = (rect.top - dropdownRect.height - 4) + 'px';
                        }
                    }, 0);
                } else {
                    dropdown.style.display = 'none';
                }
            }
        }
        
        async function seleccionarEstado(clienteId, funcionalidadId, estado) {
            try {
                const response = await fetch(`/mapa/estado/${clienteId}/${funcionalidadId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ estado_comercial: estado })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Cerrar dropdown
                    document.getElementById(`dropdown-estado-${clienteId}-${funcionalidadId}`).style.display = 'none';
                    // Recargar página
                    window.location.reload();
                } else {
                    console.error('Error:', data.error || 'Error desconocido');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Cerrar dropdowns al hacer clic fuera
        document.addEventListener('click', (event) => {
            if (!event.target.closest('.dropdown-estado') && !event.target.closest('.mapa-cell')) {
                document.querySelectorAll('.dropdown-estado').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });
        
        // Drag and Drop para reordenar columnas
        let draggedHeader = null;
        let draggedIndex = null;
        
        function inicializarDragAndDrop() {
            document.querySelectorAll('.cliente-header').forEach((header, index) => {
            header.addEventListener('dragstart', (e) => {
                draggedHeader = header;
                draggedIndex = index;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', header.innerHTML);
                header.style.opacity = '0.5';
            });
            
            header.addEventListener('dragend', (e) => {
                header.style.opacity = '1';
                document.querySelectorAll('.cliente-header').forEach(h => {
                    h.style.borderLeft = '';
                    h.style.borderRight = '';
                });
            });
            
            header.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                if (draggedHeader && draggedHeader !== header) {
                    const rect = header.getBoundingClientRect();
                    const midpoint = rect.left + rect.width / 2;
                    const mouseX = e.clientX;
                    
                    // Mostrar indicador visual
                    document.querySelectorAll('.cliente-header').forEach(h => {
                        h.style.borderLeft = '';
                        h.style.borderRight = '';
                    });
                    
                    if (mouseX < midpoint) {
                        header.style.borderLeft = '3px solid var(--primary-color)';
                    } else {
                        header.style.borderRight = '3px solid var(--primary-color)';
                    }
                }
            });
            
            header.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (draggedHeader && draggedHeader !== header) {
                    const targetIndex = Array.from(header.parentNode.children).indexOf(header);
                    const draggedIndex = Array.from(draggedHeader.parentNode.children).indexOf(draggedHeader);
                    
                    // Mover header
                    if (draggedIndex < targetIndex) {
                        header.parentNode.insertBefore(draggedHeader, header.nextSibling);
                    } else {
                        header.parentNode.insertBefore(draggedHeader, header);
                    }
                    
                    // Mover todas las celdas de la columna correspondiente
                    const tbody = document.querySelector('#mapaTable tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    
                    rows.forEach(row => {
                        const cells = Array.from(row.querySelectorAll('td'));
                        const draggedCell = cells[draggedIndex + 1]; // +1 porque la primera columna es funcionalidad
                        const targetCell = cells[targetIndex + 1];
                        
                        if (draggedIndex < targetIndex) {
                            targetCell.parentNode.insertBefore(draggedCell, targetCell.nextSibling);
                        } else {
                            targetCell.parentNode.insertBefore(draggedCell, targetCell);
                        }
                    });
                    
                    // Actualizar data-cliente-index en todos los headers
                    document.querySelectorAll('.cliente-header').forEach((h, idx) => {
                        h.setAttribute('data-cliente-index', idx);
                    });
                }
                
                // Limpiar indicadores visuales
                document.querySelectorAll('.cliente-header').forEach(h => {
                    h.style.borderLeft = '';
                    h.style.borderRight = '';
                });
            });
            
            header.addEventListener('dragleave', (e) => {
                if (!header.contains(e.relatedTarget)) {
                    header.style.borderLeft = '';
                    header.style.borderRight = '';
                }
            });
            });
        }
        
        // Inicializar drag and drop cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            inicializarDragAndDrop();
        });
        
        // Funcionalidad de resize de columnas
        let isResizing = false;
        let currentHeader = null;
        let startX = 0;
        let startWidth = 0;
        
        function iniciarResize(e, handle) {
            isResizing = true;
            currentHeader = handle.closest('th');
            startX = e.pageX;
            startWidth = currentHeader.offsetWidth;
            
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
            
            e.preventDefault();
        }
        
        function doResize(e) {
            if (!isResizing) return;
            
            const width = startWidth + (e.pageX - startX);
            if (width >= 60) { // Mínimo 60px
                currentHeader.style.width = width + 'px';
            }
        }
        
        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
        }
    </script>
</body>
</html>

